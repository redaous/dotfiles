#!/bin/bash

set -u

#TODO: function variables should be local

f_install()
{
    declare -r match=$(grep --text --line-number '^PAYLOAD:$' $0 | cut -d ':' -f 1)
    declare -r payload_start=$((match + 1))
    tail -n +$payload_start $0 | tar xzf - -C $HOME
}

f_git_is_installed()
{
    declare -r GIT_CMD=$(which git 2> /dev/null)
    if [[ -z $GIT_CMD ]]; then
        return 0
    fi
    return 1
}

f_setup_git()
{
    declare -r GIT_INSTALLED=$(f_git_is_installed)
    if (( $GIT_INSTALLED )); then
        read -p "Name: "  MYNAME
        read -p "Email: " MYEMAIL
        $git_cmd config --global user.name  "$MYNAME"
        $git_cmd config --global user.email "$MYEMAIL"
    fi
}

f_setup_github()
{
    declare -r GIT_INSTALLED=$(f_git_is_installed)
    if (( $GIT_INSTALLED )); then
        read -p "Setup Github? " ans
        if [[ "${ans:0:1}"  ||  "${ans:0:1}" ]]; then
            read -p "Name: "  GITHUB_USER
            git config --global github.user $GITHUB_USER
        fi
    fi
}

f_setup_ssh()
{
    declare -r SSH_CMD=$(which ssh 2> /dev/null)
    if [[ -z $SSH_CMD ]]; then
        return 0
    fi

    # Setup jump host
    read -p "SSH Jump Host: " MYSSHJUMPHOST
    sed -i "s/JUMPHOST/$MYSSHJUMPHOST/g" $HOME/.ssh/config

    # Enable ControlPersist option
    declare -r SSH_MAJOR_VERSION=$(ssh -v 2>&1 | head -1 | awk '{print $1}' | awk -F_ '{print $NF}' | cut -b 1-3 | awk -F. '{print $1}')
    declare -r SSH_MINOR_VERSION=$(ssh -v 2>&1 | head -1 | awk '{print $1}' | awk -F_ '{print $NF}' | cut -b 1-3 | awk -F. '{print $2}')
    if [[ $SSH_MAJOR_VERSION -gt 5 ]]; then
        echo "Enabling SSH ControlPersist"
        sed -i 's/\#ControlPersist/ControlPersist/g' $HOME/.ssh/config
    elif [[ $SSH_MAJOR_VERSION -eq 5 && $SSH_MINOR_VERSION -ge 6 ]]; then
        echo "Enabling SSH ControlPersist"
        sed -i 's/\#ControlPersist/ControlPersist/g' $HOME/.ssh/config
    fi
}

f_setup_tmux()
{
    declare -r SSH_MAJOR_VERSION=$(ssh -v 2>&1 | head -1 | awk '{print $1}' | awk -F_ '{print $NF}' | cut -b 1-3 | awk -F. '{print $1}')
    declare -r SSH_MINOR_VERSION=$(ssh -v 2>&1 | head -1 | awk '{print $1}' | awk -F_ '{print $NF}' | cut -b 1-3 | awk -F. '{print $2}')
    if [[ $SSH_MAJOR_VERSION -gt 5 ]]; then
        echo "Enabling TMUX Proxy Command ssh -W"
        echo ""                                    >> $HOME/.tmux.conf
        echo "### DO NOT EDIT BELOW THIS LINE ###" >> $HOME/.tmux.conf
        echo "bind P command-prompt -p \"Proxy SSH Target: \" \"new-window -n %1 \\\"exec ssh -o ProxyCommand='ssh jump -W %1:22' %1\\\"\" # ssh via proxy" >> $HOME/.tmux.conf
    elif [[ $SSH_MAJOR_VERSION -eq 5 && $SSH_MINOR_VERSION -ge 4 ]]; then
        echo "Enabling TMUX Proxy Command ssh -W"
        echo ""                                    >> $HOME/.tmux.conf
        echo "### DO NOT EDIT BELOW THIS LINE ###" >> $HOME/.tmux.conf
        echo "bind P command-prompt -p \"Proxy SSH Target: \" \"new-window -n %1 \\\"exec ssh -o ProxyCommand='ssh jump -W %1:22' %1\\\"\" # ssh via proxy" >> $HOME/.tmux.conf
    else
        echo "Enabling TMUX Proxy Command nc"
        echo ""                                    >> $HOME/.tmux.conf
        echo "### DO NOT EDIT BELOW THIS LINE ###" >> $HOME/.tmux.conf
        echo "bind P command-prompt -p \"Proxy SSH Target: \" \"new-window -n %1 \\\"exec ssh -o ProxyCommand='ssh jump nc %h 22' %1\\\"\" # ssh via proxy" >> $HOME/.tmux.conf
    fi
}

read -p "Install files? " ans
if [[ "${ans:0:1}"  ||  "${ans:0:1}" ]]; then
    f_install
    
    # Do remainder of install steps.
    f_setup_git
    f_setup_github
    f_setup_ssh
    f_setup_tmux
fi
exit 0

