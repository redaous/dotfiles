#!/bin/bash

set -u

#TODO: function variables should be local

function f_install()
{
    match=$(grep --text --line-number '^PAYLOAD:$' $0 | cut -d ':' -f 1)
    payload_start=$((match + 1))
    tail -n +$payload_start $0 | tar xzf - -C $HOME
}

function f_setup_git()
{
    git_cmd=$(which git 2> /dev/null)
    if [ -z "$git_cmd" ]; then
        return 0
    fi

    read -p "Name: "  MYNAME
    read -p "Email: " MYEMAIL

    $git_cmd config --global user.name  "$MYNAME"
    $git_cmd config --global user.email "$MYEMAIL"
}

f_setup_ssh()
{
    ssh_cmd=$(which ssh 2> /dev/null)
    if [ -z "$ssh_cmd" ]; then
        return 0
    fi

    # Setup jump host
    read -p "SSH Jump Host: " MYSSHJUMPHOST
    sed -i "s/JUMPHOST/$MYSSHJUMPHOST/g" $HOME/.ssh/config

    # Enable ControlPersist option
    SSH_MAJOR_VERSION=$(ssh -v 2>&1 | head -1 | awk '{print $1}' | awk -F_ '{print $NF}' | cut -b 1-3 | awk -F. '{print $1}')
    SSH_MINOR_VERSION=$(ssh -v 2>&1 | head -1 | awk '{print $1}' | awk -F_ '{print $NF}' | cut -b 1-3 | awk -F. '{print $2}')
    if [ "$SSH_MAJOR_VERSION" -gt 5 ]; then
        echo "Enabling SSH ControlPersist"
        sed -i 's/\#ControlPersist/ControlPersist/g' $HOME/.ssh/config
    elif [ "$SSH_MAJOR_VERSION" -eq 5 -a "$SSH_MINOR_VERSION" -ge 6 ]; then
        echo "Enabling SSH ControlPersist"
        sed -i 's/\#ControlPersist/ControlPersist/g' $HOME/.ssh/config
    fi
}

read -p "Install files? " ans
if [[ "${ans:0:1}"  ||  "${ans:0:1}" ]]; then
    f_install
    
    # Do remainder of install steps.
    f_setup_git
    f_setup_ssh
fi

exit 0

